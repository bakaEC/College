1. # Chapter 3.3 宽字节注入


  [TOC]

   ## 原理

   ### 魔术引号

   魔术引号是一个在PHP5.3.0以前存在的特性，当配置文件中存`magic_quotes_gpc = On`时，证明魔术引号打开。

   当其处于此状态时，所有的 `'`，` " `，`\`和 `NULL字符`都会被自动加上一个反斜线`\`进行转义过滤。

   **魔术引号对于做网页渗透的影响**：用户输入的数据被过滤后都成为了字符串，无法直接插入代码进行SQL注入。

   ### 宽字节注入

   由于部分网站常用GBK编码格式，而GBK编码格式的特点是无论是中文还是其他符号都使用两个字节进行表示，比如说`%df%5c`在汉字集中代表`運`字。但是由于网站维护人员很有可能因为PHP发送到MySQL时设置错误导致字符集再次编码转换等情况，造成了宽字节注入的漏洞。

   ## 思路

   结合上文魔术引号和宽字节注入的原理可知，当一个网页处于魔术引号打开状态时，用户输入的特殊字符会被`\`**转义为普通字符串**，那么当网页存在宽字节注入时，我们只需要将`\`与其他十六进制码组合为一个新的字符，便可以将其抵消了。

   过程：

   1. 已知转义符`\`的GBK码为`%5c`；
   2. 我们只需要在其前面加入大于127的十六进制码（如`%df`）便能让其组合，被MySQL服务器认定为汉字（如`"運"`**%df%5c**），此时`\`被排除，注入语句可以运行。

   ## 过程

   ### Rank1

   1. 首先使用 **' and 1=2** 判断页面返回，可见我们输入的单引号及之后部分被`\`**转义为字符串**

   	![](https://nc0.cdn.zkaq.cn/md/5371/00b2759ebb7a844d54d92bfdb2c87363_90863.png)

   2. 此时我们尝试在单引号前加入`%df`，可见页面返回不正常，证明宽字节注入生效

   	![](https://nc0.cdn.zkaq.cn/md/5371/8072a228a806cc7ecef479d239b8d730_16170.png)
   3. 按照基本的注入方式查询库名和内含flag的表名

   	![](https://nc0.cdn.zkaq.cn/md/5371/8a7b61d4bf1e5b6c73318b44d26dcafb_34087.png)
   4. 在查询字段名时，由于参数`table_name=`后**必须为字符串**，在以往的经验中我们使用的是单引号装载，但是在此由于魔术引号导致单引号**仍然被转义**，并且此处也无法消除宽字节注入时产生的汉字的影响，所以将表名转换为16进制字符串，加上`0x`标识，就能被服务器解析为字符串

   	![](https://nc0.cdn.zkaq.cn/md/5371/7423f705c2ca462be24c94e7910a6643_26935.png)

   6. 成功获取flag

   	![](https://nc0.cdn.zkaq.cn/md/5371/79b8fe165c9de98c5b40b6947d98e368_12192.png)

   ### Rank2

   与Rank1相同，注意**双引号**和**后括号**的闭合。

   ### Rank3

   此题属于post输入框，我们适当的使用本章宽字节注入和上章节提到的盲注思想。

   1. 首先尝试自己闭合输入框，加入注入语句，发现注入失败，手动闭合框被转义

   	![](https://nc0.cdn.zkaq.cn/md/5371/1aeb41cc8c3521842a87327c648ab93d_59136.png)
   2. 尝试加入`%df`，由于输入框不支持URL转义，所以无法使用

   	![](https://nc0.cdn.zkaq.cn/md/5371/f84e167fe322451dba96fcce9cdf76df_88106.png)
   3. 使用其他汉字代替，返回成功结果，证明可以注入

   	![](https://nc0.cdn.zkaq.cn/md/5371/89f51c91dd850bf074441ecfc6eb0171_78138.png)
   4. 使用盲注判断数据库长度

   	![](https://nc0.cdn.zkaq.cn/md/5371/01628c34f38b2c713475de1e36beae10_88869.png)
   5. 利用长度用burp跑一遍数据库名

   	![](https://nc0.cdn.zkaq.cn/md/5371/5a68fdfec12a889b355937f538a96308_14384.png)
   	![](https://nc0.cdn.zkaq.cn/md/5371/3cb8f0d3cf19dd7ec3741cbde81d695f_32779.png)
   6. 十进制转义为ascii码，得到库名

   	![](https://nc0.cdn.zkaq.cn/md/5371/208703407d850b0b5753c7e76f2eec43_84822.png)
   7. 其余部分参考上一章Chapter 3.2 盲注

   ## 思考

   1. 当使用SQLmap工具进行暴破时，对于存在魔术引号的注入点可以尝试使用`?id=%df'`。
   3. 之所以可以在post输入框使用单个汉字抵消`\`是因为GBK汉字占**2字符**,反斜杠占**1字符**，而转为UTF-8后所有以上文字/符号占**3字符**，所以进入GBK数据库时之前的汉字+反斜杠会变成一个字。
   2. 经查证，漏洞发生在PHP请求mysql时使用character_set_client值进行一次转码，这就意味着在进行第一次PHP解析转码时，UTF8转向GBK时转义字符重构才导致被`\`抵消了，所以建议在后端统一使用窄字节。