# Chapter 8.4 SSRF

[TOC]

## 0x00 漏洞简介

服务器端请求伪造（SSRF）是指攻击者能够从易受攻击的Web应用程序发送自定义请求，使其对其他网站进行攻击。也就是利用一个可发起网络请求的服务当作跳板来攻击其他服务器。攻击者能够利用目标帮助攻击者访问其他想要攻击的目标，这样在溯源追查时几乎无法识别到攻击者，通过此方式攻击者也有途径访问到目标服务器内网。

## 0x01 漏洞危害

1. 控制目标服务器进行内网扫描
2. 向目标内部任意服务器的任意端口发送数据
3. DOS攻击
4. 暴力穷举用户、目录、文件

## 0x02 判断方法

1. 验证请求发出方是否为合法用户
2. 验证对外发起的网络请求是否合法
3. 验证`file`协议黑白名单
4. 验证`dict`协议黑白名单

## 0x03 漏洞复现

1. 观察网页功能，能通过此网页get传参访问到其他网页

	![](https://nc0.cdn.zkaq.cn/md/5371/266aecebadaecf7a9d63e2cf2eefa384_19995.png)
	![](https://nc0.cdn.zkaq.cn/md/5371/b6c11b4901133967a55b7524ab375a3c_69955.png)
2. 尝试使用DNS解析本地内网，成功

	![](https://nc0.cdn.zkaq.cn/md/5371/15e01acf5483f0ea78f91d0c78c8d106_96654.png)
	![](https://nc0.cdn.zkaq.cn/md/5371/9c7f893aea6da2372849ecbb0dddada7_17383.png)
3. 尝试使用`dict://`扫描内部开放端口，设置端口号1~255的payload

	![](https://nc0.cdn.zkaq.cn/md/5371/ab44e89be0f466cd266af17e0fcd2128_56569.png)
4. 跑包，得到两个400服务器拒绝端口

	![](https://nc0.cdn.zkaq.cn/md/5371/285122e1ddbd1ab0f058a81199e8380f_23175.png)
5. 尝试通过页面连接，成功。通过审查源码得到flag

	![](https://nc0.cdn.zkaq.cn/md/5371/0fcb1a79420c88c27235f331f0f95755_64473.png)

## 0x04 防御方法

1. 限制从外部连接到内网IP，限制内网IP传参

2. 限制请求的端口

3. 统一对外报错信息

4. 内部访问的身份验证

5. 禁用函数

   `file_get_contents()`、`fsockopen()`、`curl_exec()`