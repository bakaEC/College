# Chapter 8.3 在线支付漏洞

[TOC]

## 0x00 漏洞简介及常见形式

​	支付漏洞属于危害性较大的逻辑漏洞，在电商和在线经济发达的今天，支付漏洞仍然在威胁着安全性较低的在线交易网站。在支付逻辑存在漏洞时如果被不法分子利用则势必造成大量经济损失。

商户网站接入支付结果有两种方式，一种是通过浏览器进行跳转通知，一种是服务器端异步通知

**浏览器跳转**

基于用户访问的浏览器，如果用户在银行页面支付成功后，直接关闭了页面，并未等待银行跳转到支付结果页面，那么商户网站就收不到支付结果的通知，导致支付结果难以处理。而且浏览器端数据很容易被篡改而降低安全性

**服务器端异步通知**

该方式是支付公司服务器后台直接向用户指定的异步通知URL发送参数，采用POST或GET的方式。商户网站接收异部参数的URL对应的程序中，要对支付公司返回的支付结果进行签名验证，成功后进行支付逻辑处理，如验证金额、订单信息是否与发起支付时一致，验证正常则对订单进行状态处理或为用户进行网站内入账等

### 0b001 支付过程中可直接修改包中的支付金额

> 最常见

这种漏洞形式主要针对网站使用第三方交易/支付平台所出现。在开发时开发人员可能会为了方便直接在传递支付的关键数据包中假如金额数据，并且后端不做校验，导致可以随意更改金额传参进行提交。

### 0b010 没有对购买数量进行限制

这种漏洞形式主要针对网站拥有自己的虚拟货币环境的情况。漏洞产生的原因是开发人员没有对购买商品的数量参数进行严格的限制。这种同样是数量的参数没有做签名，在抓包后导致可随意修改数量，经典的修改方式就是修改为负数。而当购买的数量是一个负数时，总额的算法仍然是`购买数量x单价=总价`。所以这样就会导致有一个**负数**的**需支付金额**。若支付成功，则可能导致购买到了一个负数数量的产品，也有可能购物网站会**返还相应的虚拟货币到你的账户上**。

### 0b011 购买商品编号篡改

这种漏洞同样针对网站拥有自己的虚拟货币环境的情况。通过在购买商品支付时将支付代码篡改为价格较低的商品实现低价购买高价商品。

### 0b100 支付逻辑执行顺序缺陷

这种漏洞形式在网站使用第三方支付平台或者拥有自己的虚拟货币环境的情况都有出现。漏洞出现的原因是用户能够干预到网站跳转支付的过程，导致网站在用户生成支付订单后**直接跳转到支付成功的状态**，从而跳过支付流程。

### 0b101 请求重放

这种漏洞形式在两种情况都有出现。通过购买商品成功后重放购买成功的请求，可以使购买的商品一直增加。购买成功后，会有一个从银行向商户网站跳转的过程，如果这个过程反复的重放，有可能导致商品的反复购买和增加，但是用户不需要支付更多的金钱。

### 0b110 程序的异常处理

这种漏洞形式比较少见。程序的异常处理就是指支付的数据包异常的程序的错误处理。这种异常可以是数据与KEY不符，支付的金额有错误，购买的数量不正确等等。程序的异常处理出现的原因主要是开发人员对出现异常后的处理不当造成的，而这种漏洞可能会造成程序对返回信息解析错误，造成支付成功。

### 0b111 越权支付

与上一章越权相似，在身份认证传参可以被篡改时，越权漏洞就能造成越权支付，即用其他用户的账户支付。

## 0x01 漏洞复现

1. 注册账号，进入购买页面

	![](https://nc0.cdn.zkaq.cn/md/5371/31480f7111492a953010eac940205a9d_68381.png)
	![](https://nc0.cdn.zkaq.cn/md/5371/80a64abe997e2a45499f7ec6f2693299_85700.png)
2. 提交订单时抓包，并把购买数量改为负数

	![](https://nc0.cdn.zkaq.cn/md/5371/f21bb3befe7367befc88611920aec9d3_75168.png)
3. 在订单结算页面已经有了结果，选择余额支付后提交

	![](https://nc0.cdn.zkaq.cn/md/5371/8507d755d12f3f1209f0843747aab35b_32765.png)
4. 页面虽然返回SQL报错，但是后台已经更新了余额，也就是`扣款-x=账户+x`，数额大则出现flag

	![](https://nc0.cdn.zkaq.cn/md/5371/6f93f216081f8b82424a6df061362a0a_20927.png)
	![](https://nc0.cdn.zkaq.cn/md/5371/5ca8cd65924584f4f4804caebf4b9e6c_60937.png)

## 0x02 漏洞修复方法

1. 用户支付完成后后端检查每一项值，包括支付状态。

2. 后端校验价格、数量参数，限制购买数量

3. 与第三方支付平台同步检查，实际支付的金额是否与订单金额一致。

4. 支付参数进行MD5 加密、解密、数字签名及验证，可以有效的避免数据修改，重放攻击中的各种问题。

5. 金额超过阈值时，进行人工审核 